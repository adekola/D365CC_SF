(()=>{"use strict";({973:function(o,e){var t=this&&this.__awaiter||function(o,e,t,n){return new(t||(t=Promise))(function(r,c){function s(o){try{l(n.next(o))}catch(o){c(o)}}function a(o){try{l(n.throw(o))}catch(o){c(o)}}function l(o){var e;o.done?r(o.value):(e=o.value,e instanceof t?e:new t(function(o){o(e)})).then(s,a)}l((n=n.apply(o,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(){this.conversationStartTimes={},this.callerNumbers={}}initialize(){if(void 0===window.sforce||void 0===window.sforce.opencti){const o="/support/api/54.0/lightning/opencti.js",e=`${new URL(document.referrer).origin}${o}`;return n.loadScript(e)}return Promise.resolve(!0)}bindEvents(){var o,e;const n=null===(e=null===(o=window.Microsoft)||void 0===o?void 0:o.CCaaS)||void 0===e?void 0:e.EmbedSDK;n&&(n.conversation.onConversationLoaded(o=>{console.log("Conversation loaded:",o),console.log("Available properties:",Object.keys(o)),console.log("customerPhoneNumber:",o.customerPhoneNumber),console.log("customerName:",o.customerName);const{liveWorkItemId:e,customerPhoneNumber:t}=o;console.log(o),this.conversationStartTimes[e]=new Date,this.callerNumbers[e]=t||"",console.log("Stored phone number:",this.callerNumbers[e])}),n.conversation.onStatusChange(o=>t(this,void 0,void 0,function*(){const{liveWorkItemId:e,statusCode:t}=o;if(console.log("Status update received:",o),5===t||4===t){const o=this.conversationStartTimes[e],t=new Date,n=Math.floor((t.getTime()-o.getTime())/1e3),r=this.callerNumbers[e];let c=null,s="Unknown";if(r)try{const o=yield this.findContactByPhone(r);o?(c=o.Id,s=o.Name,console.log(`Found existing contact: ${s} (${c})`)):console.log(`No contact found for phone number: ${r}`)}catch(o){console.error("Error searching for contact:",o)}const a=Object.assign(Object.assign({Subject:`Call with ${s}`,TaskSubtype:"Call",CallType:"Inbound",CallDurationInSeconds:n,Phone:r,ActivityDate:(new Date).toISOString().split("T")[0],Status:"Completed",Priority:"Normal"},c&&{WhoId:c}),{Call_Start_Time__c:o.toISOString(),Call_End_Time__c:t.toISOString(),Description:`Inbound call from ${s} (${r||"Unknown number"})\nDuration: ${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}\nStart: ${o.toLocaleString()}\nEnd: ${t.toLocaleString()}\n`+(c?"Linked to existing contact":"No existing contact found"),entityApiName:"Task"});console.log("Enhanced Task log data to be saved:",a),window.sforce.opencti.saveLog({value:a,callback:o=>{o.success?console.log(`Task logged successfully and ${c?"linked to contact "+c:"created without contact link"}:`,o):console.error("Failed to save task:",o.errors||"An unknown error occurred.")}})}})))}static loadScript(o){return new Promise((e,t)=>{const n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=o,n.onload=function(){e(!0)},n.onerror=function(){t(new Error(`Error in loading ${o}`))},document.getElementsByTagName("head")[0].appendChild(n)})}findContactByPhone(o){return t(this,void 0,void 0,function*(){if(!o||""===o.trim())return null;const e=this.cleanPhoneNumber(o);return new Promise(o=>{window.sforce.opencti.searchAndScreenPop({searchParams:e,queryParams:"Contact",callType:window.sforce.opencti.CALL_TYPE.INBOUND,callback:e=>{var t;if(console.log("=== FULL SEARCH RESULT DEBUG ==="),console.log("result.success:",e.success),console.log("result.returnValue type:",typeof e.returnValue),console.log("result.returnValue:",JSON.stringify(e.returnValue,null,2)),console.log("result.returnValue keys:",Object.keys(e.returnValue||{})),e.success&&e.returnValue){let n=e.returnValue;const r=this.parseContactSearchResults(n);if(r&&r.length>0)return console.log("Found contact via parsing:",r[0]),void o(r[0]);if("Contact"===n.RecordType||n.attributes&&"Contact"===n.attributes.type)return console.log("Found single Contact record via direct access"),void o({Id:n.Id,Name:n.Name||(null===(t=n.attributes)||void 0===t?void 0:t.name)||"Unknown Contact"});console.log("No Contact records found in results"),o(null)}else console.log("No contacts found or search failed:",e),o(null)}})})})}cleanPhoneNumber(o){return o.replace(/[^\d+]/g,"")}parseContactSearchResults(o){var e;try{console.log("=== PARSING SEARCH RESULTS ==="),console.log("searchResults type:",typeof o),console.log("searchResults:",o),console.log("searchResults keys:",Object.keys(o||{}));let t=o;if(o&&"object"==typeof o)if(o.records)t=o.records,console.log("Found records property:",t);else if(o.Contact)t=o.Contact,console.log("Found Contact property:",t);else if(o.data)t=o.data,console.log("Found data property:",t);else for(const[n,r]of Object.entries(o))if(console.log(`Checking property ${n}:`,r),Array.isArray(r)){const o=r.some(o=>{var e;return o&&("Contact"===o.RecordType||"Contact"===(null===(e=o.attributes)||void 0===e?void 0:e.type))});if(o){t=r,console.log(`Found Contact records in ${n} property:`,t);break}}else if(r&&"object"==typeof r&&("Contact"===(null==r?void 0:r.RecordType)||"Contact"===(null===(e=null==r?void 0:r.attributes)||void 0===e?void 0:e.type))){t=[r],console.log(`Found single Contact record in ${n} property:`,t);break}if(!Array.isArray(t)){if(!t||"object"!=typeof t||!t.Id)return console.log("Records is not an array and not a single record:",t),console.log("Available properties:",Object.keys(t||{})),null;t=[t],console.log("Converted single record to array:",t)}console.log("Processing",t.length,"records");const n=t.map((o,e)=>(console.log(`Record ${e}:`,o),console.log(`Record ${e} RecordType:`,o.RecordType),console.log(`Record ${e} attributes:`,o.attributes),o)).filter(o=>{const e="Contact"===o.RecordType||o.attributes&&"Contact"===o.attributes.type;return console.log(`Record ${o.Id} is Contact:`,e),e}).map(o=>{var e;const t={Id:o.Id,Name:o.Name||(null===(e=o.attributes)||void 0===e?void 0:e.name)||"Unknown Contact"};return console.log("Mapped contact:",t),t});return console.log("Final contacts array:",n),n.length>0?n:null}catch(e){return console.error("Error parsing contact search results:",e),console.error("searchResults that caused error:",o),null}}}window.CCaaS=window.CCaaS||{},window.CCaaS.CTIDriver||(window.CCaaS.CTIDriver=n),e.default=n}})[973](0,{})})();
