(()=>{"use strict";({973:function(e,o){var t=this&&this.__awaiter||function(e,o,t,n){return new(t||(t=Promise))(function(r,a){function c(e){try{s(n.next(e))}catch(e){a(e)}}function i(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t(function(e){e(o)})).then(c,i)}s((n=n.apply(e,o||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0});class n{constructor(){this.conversationStartTimes={},this.callerNumbers={}}initialize(){if(void 0===window.sforce||void 0===window.sforce.opencti){const e="/support/api/54.0/lightning/opencti.js",o=`${new URL(document.referrer).origin}${e}`;return n.loadScript(o)}return Promise.resolve(!0)}bindEvents(){var e,o;const n=null===(o=null===(e=window.Microsoft)||void 0===e?void 0:e.CCaaS)||void 0===o?void 0:o.EmbedSDK;n&&(n.conversation.onConversationLoaded(e=>{console.log("Conversation loaded:",e),console.log("Available properties:",Object.keys(e)),console.log("customerPhoneNumber:",e.customerPhoneNumber),console.log("customerName:",e.customerName);const{liveWorkItemId:o,customerPhoneNumber:t}=e;console.log(e),this.conversationStartTimes[o]=new Date,this.callerNumbers[o]=t||"",console.log("Stored phone number:",this.callerNumbers[o])}),n.conversation.onStatusChange(e=>t(this,void 0,void 0,function*(){const{liveWorkItemId:o,statusCode:t}=e;if(console.log("Status update received:",e),console.log(`Status code for liveWorkItemId ${o}:`,t),5===t||4===t){const e=this.conversationStartTimes[o],t=new Date,n=Math.floor((t.getTime()-e.getTime())/1e3),r=this.callerNumbers[o];let a=null,c="Unknown";if(r)try{const e=yield this.findContactByPhone(r);e?(a=e.Id,c=e.Name,console.log(`Found existing contact: ${c} (${a})`)):console.log(`No contact found for phone number: ${r}`)}catch(e){console.error("Error searching for contact:",e)}const i=Object.assign(Object.assign({Subject:`Call with ${c}`,TaskSubtype:"Call",CallType:"Inbound",CallDurationInSeconds:n,Phone:r,ActivityDate:(new Date).toISOString().split("T")[0],Status:"Completed",Priority:"Normal"},a&&{WhoId:a}),{Call_Start_Time__c:e.toISOString(),Call_End_Time__c:t.toISOString(),Description:`Inbound call from ${c} (${r||"Unknown number"})\nDuration: ${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}\nStart: ${e.toLocaleString()}\nEnd: ${t.toLocaleString()}\n`+(a?"Linked to existing contact":"No existing contact found"),entityApiName:"Task"});console.log("Enhanced Task log data to be saved:",i),window.sforce.opencti.saveLog({value:i,callback:e=>{e.success?console.log(`Task logged successfully and ${a?"linked to contact "+a:"created without contact link"}:`,e):console.error("Failed to save task:",e.errors||"An unknown error occurred.")}})}})))}static loadScript(e){return new Promise((o,t)=>{const n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=e,n.onload=function(){o(!0)},n.onerror=function(){t(new Error(`Error in loading ${e}`))},document.getElementsByTagName("head")[0].appendChild(n)})}findContactByPhone(e){return t(this,void 0,void 0,function*(){if(!e||""===e.trim())return null;const o=this.cleanPhoneNumber(e);return new Promise(e=>{window.sforce.opencti.searchAndScreenPop({searchParams:o,queryParams:"Contact",callType:window.sforce.opencti.CALL_TYPE.INBOUND,callback:o=>{if(o.success&&o.returnValue){console.log("Contact search result:",o.returnValue);const t=this.parseContactSearchResults(o.returnValue);t&&t.length>0?e(t[0]):e(null)}else console.log("No contacts found or search failed:",o),e(null)}})})})}cleanPhoneNumber(e){return e.replace(/[^\d+]/g,"")}parseContactSearchResults(e){try{return e&&e.length>0?e.filter(e=>{var o;return"Contact"===(null===(o=e.attributes)||void 0===o?void 0:o.type)}).map(e=>({Id:e.Id,Name:e.Name||`${e.FirstName||""} ${e.LastName||""}`.trim()})):null}catch(e){return console.error("Error parsing contact search results:",e),null}}}window.CCaaS=window.CCaaS||{},window.CCaaS.CTIDriver||(window.CCaaS.CTIDriver=n),o.default=n}})[973](0,{})})();
