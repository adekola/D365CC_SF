(()=>{"use strict";var e={185:function(e,o,n){var t=this&&this.__awaiter||function(e,o,n,t){return new(n||(n=Promise))(function(i,r){function c(e){try{a(t.next(e))}catch(e){r(e)}}function s(e){try{a(t.throw(e))}catch(e){r(e)}}function a(e){var o;e.done?i(e.value):(o=e.value,o instanceof n?o:new n(function(e){e(o)})).then(c,s)}a((t=t.apply(e,o||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0}),o.CUSTOMERDATAENUM=void 0,o.conversationReady=function(e,n){return t(this,void 0,void 0,function*(){return new Promise((i,l)=>t(this,void 0,void 0,function*(){let i=window.sforce.opencti.CALL_TYPE.INBOUND;n.msdyn_channel&&(Number(n.msdyn_channel)!==c.VOICE&&Number(n.msdyn_channel)!==c.VOICE_CALL||n.msdyn_isoutbound&&(i=window.sforce.opencti.CALL_TYPE.OUTBOUND));const{contactId:l,accountId:d}=yield function(e,n){return t(this,void 0,void 0,function*(){const i=new Set,c=new Set,l=yield function(e,n){return t(this,void 0,void 0,function*(){let t=[];try{return a(o.CUSTOMERDATAENUM.PHONENUMBER,e)?t=yield s(e.customerPhoneNumber,n):a(o.CUSTOMERDATAENUM.NAME,e)&&(t=yield s(e.customerName,n)),t}catch(e){throw new Error(e)}})}(e,n);return l&&l.forEach(({id:e,type:o})=>{o===r.CONTACT?i.add(e):o===r.ACCOUNT&&c.add(e)}),{contactId:1===i.size?i.values().next().value:void 0,accountId:1===c.size?c.values().next().value:void 0}})}(e,i);var u;(l||d)&&(u=l||d,new Promise((e,o)=>{window.sforce.opencti.screenPop({type:window.sforce.opencti.SCREENPOP_TYPE.SOBJECT,params:{recordId:u},callback:n=>{n.success?e(n.success):o(n.errors)}})}))}))})},o.onClickToDial=function(e){window.sforce.opencti.enableClickToDial(),window.sforce.opencti.onClickToDial({listener:o=>{const n={number:o.number};e(n),(0,i.setSoftPhonePanelVisibility)(!0)}})},o.searchForRecords=s;const i=n(200);o.CUSTOMERDATAENUM={PHONENUMBER:"customerPhoneNumber",EMAIL:"customerEmail",NAME:"customerName"};const r={CONTACT:"Contact",ACCOUNT:"Account"},c={VOICE_CALL:19244e4,VOICE:19237e4};function s(e,o){return t(this,void 0,void 0,function*(){return new Promise((n,t)=>{window.sforce.opencti.searchAndScreenPop({searchParams:e,callType:o,deferred:!0,callback:e=>{const o=[];if(e.success&&e.returnValue){for(const[n,t]of Object.entries(e.returnValue))!t||t.RecordType!==r.CONTACT&&t.RecordType!==r.ACCOUNT||o.push({id:n,type:t.RecordType});n(o)}else t(e.errors)}})})})}function a(e,o){return void 0!==o[e]&&null!==o[e]&&""!==o[e]}},200:function(e,o,n){var t=this&&this.__awaiter||function(e,o,n,t){return new(n||(n=Promise))(function(i,r){function c(e){try{a(t.next(e))}catch(e){r(e)}}function s(e){try{a(t.throw(e))}catch(e){r(e)}}function a(e){var o;e.done?i(e.value):(o=e.value,o instanceof n?o:new n(function(e){e(o)})).then(c,s)}a((t=t.apply(e,o||[])).next())})};Object.defineProperty(o,"__esModule",{value:!0}),o.setSoftPhonePanelVisibility=void 0,o.embedSDKSampleUsage=function(){const e=window.Microsoft.CCaaS.EmbedSDK;if(e){const n={};e.conversation.onNotesAdded(e=>{console.log("Embed SDK New Note Created",e)}),e.conversation.onConversationLoaded(o=>t(this,void 0,void 0,function*(){console.log("=== CONVERSATION LOADED EVENT ==="),console.log("Full conversation data:",o),console.log("Work Item ID:",o.liveWorkItemId);const t=(new Date).toISOString();console.log("Call Start Time Generated:",t),console.log("Call Start Time (Local):",(new Date).toLocaleString()),m(e);try{const n=yield e.conversation.getConversationData(o.liveWorkItemId,["msdyn_isoutbound","msdyn_channel","subject","msdyn_createdon"]);if(console.log("=== CONVERSATION DETAILS ==="),console.log("Conversation Details:",n),console.log("Channel:",n.msdyn_channel),console.log("Is Outbound:",n.msdyn_isoutbound),console.log("Subject:",n.subject),console.log("Created On:",n.msdyn_createdon),n.msdyn_createdon){const e=new Date(n.msdyn_createdon),o=new Date(t).getTime()-e.getTime();console.log("Time from creation to loaded (ms):",o),console.log("Time from creation to loaded (seconds):",o/1e3)}yield(0,i.conversationReady)(o,n)}catch(e){console.error("Failed to get conversation details:",e)}n[o.liveWorkItemId]={start:t},console.log("=== CALL TIMES STORAGE ==="),console.log("Stored call times object:",n),console.log("Current conversation call time:",n[o.liveWorkItemId]),console.log("=== SALESFORCE UPDATE ==="),console.log("Attempting to update Salesforce with:"),console.log("- Conversation ID:",o.liveWorkItemId),console.log("- Start Time:",t),console.log("- Field to update: Call_Start_Time_c__c"),C(o.liveWorkItemId,{Call_Start_Time_c__c:t},"start"),a(e),console.log("=== END CONVERSATION LOADED EVENT ===\n")})),e.conversation.onTransfer(e=>{console.log("Embed SDK Conversation Transferred",e)}),e.conversation.onStatusChange(o=>{if(console.log("Embed SDK Conversation State Changed",o),o.statusCode===s.WrapUp||o.statusCode===s.Closed){const e=(new Date).toISOString();n[o.liveWorkItemId]||(n[o.liveWorkItemId]={}),n[o.liveWorkItemId].end=e,C(o.liveWorkItemId,{Call_End_Time_c__c:e},"end")}o.statusCode===s.Closed&&l(e,o.liveWorkItemId)}),e.conversation.onNewMessage(e=>{console.log("Embed SDK New Message",e)}),e.conversation.onAccept(o=>{console.log("Embed SDK Conversation Accepted",o),d(e),u(e),v(e,o.liveWorkItemId),f(e,o.liveWorkItemId),g(e,o.liveWorkItemId)}),e.conversation.onReject(e=>{console.log("Embed SDK Conversation Rejected",e)}),e.conversation.onConsultStart(e=>{console.log("Embed SDK Consult Started",e)}),e.conversation.onConsultEnd(e=>{console.log("Embed SDK Consult Ended",e)}),e.conversation.onCustomerSentimentChange(e=>{console.log("Embed SDK Customer Sentiment Changed",e)}),e.notification.onNewConversationNotification(e=>{console.log("Embed SDK New Conversation Notification",e)}),e.notification.onNewNotification(e=>{console.log("Embed SDK New Notification",e)}),e.presence.onPresenceChange(e=>{console.log("Embed SDK Agent Presence Changed",e)}),e.voiceOrVideoCalling.onHoldChange(e=>{console.log("Embed SDK Call hold changed",e)}),e.voiceOrVideoCalling.onMuteChange(e=>{console.log("Embed SDK Call mute changed",e)}),e.ctiDriver.onSoftPhonePanelHeightChange(e=>{w(e)}),e.ctiDriver.onSoftPhonePanelWidthChange(e=>{S(e)}),e.ctiDriver.onSoftPhonePanelVisibilityChange(e=>{(0,o.setSoftPhonePanelVisibility)(e)}),(0,i.onClickToDial)(e.ctiDriver.clickToDial)}};const i=n(185);var r,c,s;!function(e){e.AVAILABLE="AVAILABLE",e.AWAY="AWAY",e.BUSY="BUSY",e.BUSY_DO_NOT_DISTURB="BUSY_DO_NOT_DISTURB",e.OFFLINE="OFFLINE"}(r||(r={})),function(e){e[e.Success=1]="Success",e[e.Error=2]="Error",e[e.Warning=3]="Warning",e[e.Information=4]="Information"}(c||(c={})),function(e){e[e.Active=2]="Active",e[e.WrapUp=5]="WrapUp",e[e.Closed=4]="Closed"}(s||(s={}));const a=e=>{e.presence.getPresence().then(e=>{console.log("Embed SDK Agent's Current Presence:",e)}).catch(e=>{console.error("Embed SDK Failed to retrieve agent's presence status:",e)}),e.presence.getPresenceOptions().then(o=>{console.log("Embed SDK Available Presence Options:",o);const n=o.find(e=>e.basePresenceStatus===r.BUSY_DO_NOT_DISTURB);n?e.presence.setPresence(n.presenceId).then(()=>{console.log("Embed SDK Agent's presence status has been updated to 'busyDND'.")}).catch(e=>{console.error("Embed SDK Failed to update agent's presence status:",e)}):console.warn("Embed SDK 'busyDND' presence option not found.")}).catch(e=>{console.error("Embed SDK Failed to retrieve presence options:",e)})},l=(e,o)=>{e.conversation.getTranscript(o).then(e=>{console.log("Embed SDK Transcript",e)}).catch(e=>{console.error("Embed SDK Failed to retrieve transcript:",e)})},d=e=>{const o={level:c.Information,message:"New conversation assigned to you!"};e.notification.addNewNotification(o).then(e=>{console.log("Embed SDK Notification added with ID:",e)}).catch(e=>{console.error("Embed SDK Failed to add notification:",e)})},u=e=>{e.conversation.getAssignedConversationsList(s.Active).then(e=>{console.log("Embed SDK getAssignedConversationsList: Assigned Conversations:",e)}).catch(e=>{console.error("Embed SDK getAssignedConversationsList: Failed to retrieve assigned conversations:",e)})},m=e=>{e.conversation.getFocusedConversationId().then(e=>{console.log("Embed SDK getFocusedConversationId:  Focused Conversation ID:",e)}).catch(e=>{console.error("Embed SDK getFocusedConversationId:  Failed to retrieve focused conversation ID:",e)})},v=(e,o)=>{e.conversation.getConversationData(o,["msdyn_ocliveworkitemid","msdyn_channel","statuscode","msdyn_createdon"]).then(e=>{console.log("Embed SDK Conversation data:",e)}).catch(e=>{console.error("Embed SDK Failed to retrieve conversation data:",e)})},f=(e,o)=>{e.dataverse.retrieveRecord("msdyn_ocliveworkitems",o,"?$select=msdyn_createdon").then(e=>console.log("Embed SDK  Retrieve record Response:",e)).catch(e=>console.error("Embed SDK Failed to retrieve record:",e))},g=(e,o)=>{const n=`<fetch top="50"><entity name="msdyn_ocliveworkitem"><attribute name="msdyn_ocliveworkitemid"/><attribute name="msdyn_channel"/><attribute name="statuscode"/><attribute name="msdyn_createdon"/><filter><condition attribute="msdyn_ocliveworkitemid" operator="eq" value="${o}"/></filter></entity></fetch>`;e.dataverse.retrieveMultipleRecords("msdyn_ocliveworkitems",`?fetchXml=${n}`).then(e=>console.log("Embed SDK  Retrieve multiple records Response:",e)).catch(e=>console.error("Embed SDK Failed to retrieve multiple records:",e))},S=e=>{window.sforce.opencti.setSoftphonePanelWidth({widthPX:e})},w=e=>{window.sforce.opencti.setSoftphonePanelHeight({heightPX:e})};function C(e,o,n){console.log(`Updating Salesforce record for conversation ${e} with ${n} time:`,o),window.sforce&&window.sforce.interaction?window.sforce.interaction.getPageInfo(t=>{t.success&&t.returnValue.primaryTabId?window.sforce.interaction.getFocusedPrimaryTabObjectId(t=>{t.success&&t.returnValue?p(t.returnValue,o,n):(console.warn(`Failed to get focused tab object ID for ${n} time update:`,t),h(e,o,n))}):(console.warn(`Failed to get page info for ${n} time update:`,t),h(e,o,n))}):(console.warn("Salesforce Open CTI API not available, using fallback method"),console.log(`Mock Salesforce update: Record for conversation ${e} would be updated with:`,o))}function p(e,o,n){window.sforce&&window.sforce.connection?(Object.keys(o).map(e=>({key:e,value:o[e]})),window.sforce.connection.update([Object.assign({Id:e},o)],o=>{o&&o[0]&&o[0].success?console.log(`Call ${n} time successfully updated in Salesforce record ${e}`):console.error(`Failed to update call ${n} time in Salesforce:`,o)})):window.sforce&&window.sforce.interaction?(Object.keys(o).map(e=>`${e}: '${o[e]}'`).join(", "),window.sforce.interaction.runApex("updateCallTiming",JSON.stringify({recordId:e,fields:o}),e=>{e.success?console.log(`Call ${n} time successfully updated via Apex`):console.error(`Failed to update call ${n} time via Apex:`,e)})):console.warn(`No suitable Salesforce API available for updating ${n} time`)}function h(e,o,n){if(console.log(`Attempting to find Salesforce record by conversation ID: ${e}`),window.sforce&&window.sforce.connection){const t=`SELECT Id FROM Case WHERE Name = '${e}' OR CaseNumber = '${e}' LIMIT 1`;window.sforce.connection.query(t,t=>{t.done&&t.size>0?p(t.records[0].Id,o,n):console.warn(`No Salesforce record found for conversation ID: ${e}`)})}else console.warn("Salesforce connection API not available for record lookup")}o.setSoftPhonePanelVisibility=(e=!0)=>{e!==window.sforce.opencti.isSoftphonePanelVisible({callback:e=>{if(e.success)return e.returnValue.visible;throw new Error(e.errors)}})&&window.sforce.opencti.setSoftphonePanelVisibility({visible:e})}}},o={};function n(t){var i=o[t];if(void 0!==i)return i.exports;var r=o[t]={exports:{}};return e[t].call(r.exports,r,r.exports,n),r.exports}(()=>{const e=n(200);class o{initialize(){if(void 0===window.sforce||void 0===window.sforce.opencti){const e="/support/api/54.0/lightning/opencti.js",n=`${new URL(document.referrer).origin}${e}`;return o.loadScript(n)}return Promise.resolve(!0)}bindEvents(){(0,e.embedSDKSampleUsage)()}static loadScript(e){return new Promise((o,n)=>{const t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=e,t.onload=function(){o(!0)},t.onerror=function(){n(new Error(`Error in loading ${e}`))},document.getElementsByTagName("head")[0].appendChild(t)})}}window.CCaaS=window.CCaaS||{},window.CCaaS.CTIDriver||(window.CCaaS.CTIDriver=o)})()})();
